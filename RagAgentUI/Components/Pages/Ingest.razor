@page "/ingest"
@using RagAgentUI.Services
@using RagAgentUI.Models
@inject RagApiClient ApiClient

<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-12 px-4">
 <div class="max-w-2xl mx-auto">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
 <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
      Add Document
     </h1>
           <p class="text-gray-600 dark:text-gray-400 mb-8">
       Ingest a URL into the knowledge base. The system will automatically detect the best agent.
   </p>
  
      <div class="space-y-6">
   <!-- URL Input -->
       <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
         Document URL
      </label>
        <input @bind="urlInput"
     @bind:event="oninput"
        type="url"
     placeholder="https://github.com/microsoft/semantic-kernel"
        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 
      bg-white dark:bg-gray-700 text-gray-900 dark:text-white
      focus:outline-none focus:ring-2 focus:ring-blue-500" />
     
     <div class="mt-2 text-sm text-gray-500">
         Supported: GitHub repos, YouTube videos, arXiv papers, news articles, web pages
       </div>
   </div>
   
      <!-- Submit Button -->
      <button @onclick="IngestUrl"
       disabled="@(string.IsNullOrWhiteSpace(urlInput) || isIngesting)"
    class="w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 
          text-white rounded-lg font-medium transition-colors text-lg
    disabled:cursor-not-allowed">
   @(isIngesting ? "Processing..." : "Ingest Document")
     </button>
  </div>
       
   <!-- Progress/Status -->
      @if (ingestStatuses.Any())
  {
     <div class="mt-8 space-y-3">
   @foreach (var status in ingestStatuses)
      {
        <div class="flex items-center gap-3 p-4 rounded-lg @(status.IsComplete ? "bg-green-50 dark:bg-green-900/20" : "bg-blue-50 dark:bg-blue-900/20")">
      @if (status.IsComplete)
     {
        <span class="text-green-500 text-xl">‚úÖ</span>
       }
   else if (status.IsActive)
{
      <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      }
       else
        {
   <span class="text-gray-400 text-xl">‚è∏Ô∏è</span>
     }
        <span class="font-medium @(status.IsComplete ? "text-green-700 dark:text-green-300" : "text-gray-700 dark:text-gray-300")">
 @status.Label
  </span>
 </div>
   }
      </div>
      }
        
     @if (!string.IsNullOrEmpty(ingestResult))
    {
  <div class="mt-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
    <div class="flex items-start gap-3">
    <span class="text-green-500 text-2xl">üéâ</span>
     <div>
       <p class="font-medium text-green-700 dark:text-green-300">
          Success!
   </p>
        <p class="text-sm text-green-600 dark:text-green-400 mt-1">
     @ingestResult
 </p>
   </div>
        </div>
   </div>
    }
 
     @if (!string.IsNullOrEmpty(errorMessage))
     {
      <div class="mt-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
    <div class="flex items-start gap-3">
    <span class="text-red-500 text-2xl">‚ùå</span>
     <div>
     <p class="font-medium text-red-700 dark:text-red-300">
    Error
     </p>
      <p class="text-sm text-red-600 dark:text-red-400 mt-1">
 @errorMessage
  </p>
      </div>
     </div>
      </div>
     }
 </div>
   </div>
</div>

@code {
    private string urlInput = string.Empty;
    private bool isIngesting = false;
   private string? ingestResult = null;
    private string? errorMessage = null;
  
 private List<IngestStep> ingestStatuses = new();
    
 private async Task IngestUrl()
    {
      if (string.IsNullOrWhiteSpace(urlInput)) return;
     
      isIngesting = true;
       ingestResult = null;
      errorMessage = null;
  
    ingestStatuses = new List<IngestStep>
      {
       new("Agent Selection", false, false),
         new("Scraping", false, false),
     new("Chunking", false, false),
 new("Embedding", false, false),
new("Storing", false, false)
   };
     
       try
       {
       // Simulate progressive status (in real implementation, use SignalR for real-time updates)
      foreach (var step in ingestStatuses)
        {
    step.IsActive = true;
     StateHasChanged();
       await Task.Delay(500);
     step.IsActive = false;
     step.IsComplete = true;
   StateHasChanged();
        }
      
  var response = await ApiClient.IngestUrlAsync(urlInput);
     ingestResult = response.Message;
   urlInput = string.Empty;
    }
     catch (Exception ex)
   {
  errorMessage = ex.Message;
        // Mark all remaining steps as incomplete
        foreach (var step in ingestStatuses.Where(s => s.IsActive))
     {
     step.IsActive = false;
        }
       }
  finally
 {
   isIngesting = false;
   StateHasChanged();
     }
    }
   
    private class IngestStep
  {
    public string Label { get; set; }
      public bool IsActive { get; set; }
     public bool IsComplete { get; set; }
   
    public IngestStep(string label, bool isActive, bool isComplete)
       {
    Label = label;
      IsActive = isActive;
         IsComplete = isComplete;
   }
    }
}